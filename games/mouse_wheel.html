<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº²é¿çƒéŠæˆ² - ä¿¡å…ƒè€å¸«é›»è…¦æ•™å­¸ç¶²</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            overflow: hidden;
            user-select: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .game-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .pause-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pause-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        .pause-btn:active {
            transform: scale(0.95);
        }

        .game-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 30px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .game-area {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #0a0a0a 0%, #1a1a2e 30%, #16213e 70%, #0f3460 100%);
            overflow: hidden;
        }

        .stickman {
            position: absolute;
            bottom: 100px;
            left: 50%;
            width: 60px;
            height: 80px;
            transform: translateX(-50%);
            z-index: 10;
            transition: left 0.1s ease, background-image 0.1s ease;
            background-image: url('../static/mouse-wheel/standing_right.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* ç«æŸ´äººå‹•ç•«ç‹€æ…‹ */
        .stickman.moving-left {
            background-image: url('../static/mouse-wheel/moving_left.png');
            animation: walkLeft 0.8s infinite;
        }

        .stickman.moving-right {
            background-image: url('../static/mouse-wheel/moving_right.png');
            animation: walkRight 0.8s infinite;
        }

        .stickman.standing-left {
            background-image: url('../static/mouse-wheel/standing_left.png');
        }

        .stickman.standing-right {
            background-image: url('../static/mouse-wheel/standing_right.png');
        }

        /* è¡Œèµ°å‹•ç•« */
        @keyframes walkLeft {
            0% { background-image: url('../static/mouse-wheel/moving_left.png'); }
            25% { background-image: url('../static/mouse-wheel/moving_left (2).png'); }
            50% { background-image: url('../static/mouse-wheel/moving_left (3).png'); }
            75% { background-image: url('../static/mouse-wheel/moving_left (4).png'); }
            100% { background-image: url('../static/mouse-wheel/moving_left (5).png'); }
        }

        @keyframes walkRight {
            0% { background-image: url('../static/mouse-wheel/moving_right.png'); }
            25% { background-image: url('../static/mouse-wheel/moving_right (2).png'); }
            50% { background-image: url('../static/mouse-wheel/moving_right (3).png'); }
            75% { background-image: url('../static/mouse-wheel/moving_right (4).png'); }
            100% { background-image: url('../static/mouse-wheel/moving_right (5).png'); }
        }

        /* èª¿è©¦æ¨¡å¼ï¼šé¡¯ç¤ºç¢°æ’å€åŸŸé‚Šæ¡† */
        .debug-mode .stickman::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 60px;
            border: 3px solid red;
            background: transparent;
            pointer-events: none;
            z-index: 30;
        }

        /* èª¿è©¦æ¨¡å¼ï¼šé¡¯ç¤ºè§’è½æª¢æ¸¬å€åŸŸ */
        .debug-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 50px;
            height: 100vh;
            background: rgba(255, 0, 0, 0.1);
            pointer-events: none;
            z-index: 5;
        }
        
        .debug-mode::after {
            content: '';
            position: fixed;
            top: 0;
            right: 0;
            width: 50px;
            height: 100vh;
            background: rgba(255, 0, 0, 0.1);
            pointer-events: none;
            z-index: 5;
        }

        /* èª¿è©¦æ¨¡å¼ï¼šé¡¯ç¤ºçƒçš„ç¢°æ’ç®± */
        .debug-mode .ball::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border: 2px solid yellow;
            background: rgba(255, 255, 0, 0.1);
            pointer-events: none;
            z-index: 25;
            box-sizing: border-box;
            border-radius: 50%;
        }

        .ball {
            position: absolute;
            border-radius: 50%;
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            line-height: 1.1;
            text-align: center;
            user-select: none;
            pointer-events: none;
            border: 3px solid;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        /* ä¹ç¨®ä¸åŒè¨­è¨ˆçš„çƒ */
        .ball.type1 {
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, #ff0080, #ff4080);
            border-color: #ff0080;
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
        }

        .ball.type2 {
            width: 140px;
            height: 140px;
            background: linear-gradient(45deg, #00ffff, #40ffff);
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .ball.type3 {
            width: 160px;
            height: 160px;
            background: linear-gradient(45deg, #8000ff, #a040ff);
            border-color: #8000ff;
            box-shadow: 0 0 20px rgba(128, 0, 255, 0.5);
        }

        .ball.type4 {
            width: 180px;
            height: 180px;
            background: linear-gradient(45deg, #ff8000, #ffa040);
            border-color: #ff8000;
            box-shadow: 0 0 20px rgba(255, 128, 0, 0.5);
        }

        .ball.type5 {
            width: 200px;
            height: 200px;
            background: linear-gradient(45deg, #00ff80, #40ffa0);
            border-color: #00ff80;
            box-shadow: 0 0 20px rgba(0, 255, 128, 0.5);
        }

        .ball.type6 {
            width: 220px;
            height: 220px;
            background: linear-gradient(45deg, #ff4080, #ff80a0);
            border-color: #ff4080;
            box-shadow: 0 0 20px rgba(255, 64, 128, 0.5);
        }

        .ball.type7 {
            width: 240px;
            height: 240px;
            background: linear-gradient(45deg, #4080ff, #80a0ff);
            border-color: #4080ff;
            box-shadow: 0 0 20px rgba(64, 128, 255, 0.5);
        }

        .ball.type8 {
            width: 260px;
            height: 260px;
            background: linear-gradient(45deg, #ff8040, #ffa080);
            border-color: #ff8040;
            box-shadow: 0 0 20px rgba(255, 128, 64, 0.5);
        }

        .ball.type9 {
            width: 280px;
            height: 280px;
            background: linear-gradient(45deg, #80ff40, #a0ff80);
            border-color: #80ff40;
            box-shadow: 0 0 20px rgba(128, 255, 64, 0.5);
        }

        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border-top: 4px solid #00ffff;
            box-shadow: 0 -4px 20px rgba(0, 255, 255, 0.3);
            z-index: 1;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 200;
            display: none;
        }

        .game-over h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .game-stats {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-weight: bold;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
        }

        .game-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-actions .btn {
            min-width: 120px;
        }

        .instructions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .instructions-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            text-align: left;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .instructions-content h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .instructions-text {
            color: #555;
            font-size: 1em;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .instructions-text p {
            margin-bottom: 10px;
        }

        .instructions-text strong {
            color: #333;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        .warning {
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <a href="#" class="back-btn" onclick="handleBackClick(event)">è¿”å›</a>

    <div class="game-container">
        <!-- éŠæˆ²èªªæ˜å½ˆçª— -->
        <div id="gameInstructions" class="instructions-overlay">
            <div class="instructions-content">
                <h2>ğŸ® èº²é¿çƒéŠæˆ²</h2>
                <div class="instructions-text">
                    <p>ğŸ¯ <strong>éŠæˆ²ç›®æ¨™ï¼š</strong>æ“æ§ç«æŸ´äººèº²é¿æ‰è½ä¸‹ä¾†çš„çƒï¼ŒæŒ‘æˆ°å€‹äººæœ€é«˜å­˜æ´»ç§’æ•¸</p>
                    <p>ğŸ–±ï¸ <strong>æ“æ§æ–¹å¼ï¼š</strong></p>
                    <ul>
                        <li>æ»¾è¼ªå‘ä¸‹æ»¾å‹• = ç«æŸ´äººå¾€å³èµ°</li>
                        <li>æ»¾è¼ªå‘ä¸Šæ»¾å‹• = ç«æŸ´äººå¾€å·¦èµ°</li>
                        <li>ç©ºç™½éµ = æš«åœ/ç¹¼çºŒéŠæˆ²</li>
                        <li>ESCéµ = å¼·åˆ¶çµæŸéŠæˆ²</li>
                        <li>Déµ = åˆ‡æ›èª¿è©¦æ¨¡å¼ï¼ˆé¡¯ç¤ºç¢°æ’å€åŸŸï¼‰</li>
                    </ul>
                    <p>âš½ <strong>éŠæˆ²èªªæ˜ï¼š</strong></p>
                    <ul>
                        <li>å¤©ç©ºä¸­æœƒæ‰è½å¤§å¤§å°å°çš„çƒ</li>
                        <li>çƒç›¸æ’æˆ–è½åœ°å¾Œæœƒåå°„</li>
                        <li>ç«æŸ´äººä¸èƒ½è¢«çƒæ“Šä¸­</li>
                        <li>å­˜æ´»æ™‚é–“è¶Šé•·åˆ†æ•¸è¶Šé«˜</li>
                    </ul>
                    <p>âš ï¸ <strong>æ³¨æ„ï¼š</strong>çƒçš„é€Ÿåº¦æœƒéš¨è‘—æ™‚é–“é€æ¼¸åŠ å¿«ï¼</p>
                </div>
                <button class="btn btn-primary" onclick="startGameWithInstructions()">æˆ‘çŸ¥é“äº†ï¼Œé–‹å§‹éŠæˆ²ï¼</button>
            </div>
        </div>

        <div class="game-header">
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">å­˜æ´»æ™‚é–“</div>
                    <div class="info-value" id="survivalTime">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æœ€é«˜ç§’æ•¸</div>
                    <div class="info-value" id="bestTime">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">çƒæ•¸</div>
                    <div class="info-value" id="ballCount">0</div>
                </div>
            </div>
        </div>
        
        <button class="pause-btn" id="pauseBtn" onclick="togglePause()">â¸ï¸</button>

        <div class="game-area" id="gameArea">
            <div class="stickman" id="stickman"></div>
            <div class="ground"></div>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <h2>éŠæˆ²çµæŸï¼</h2>
        <div class="final-score" id="finalScore">0ç§’</div>
        <div class="game-stats" id="gameStats">
            <div class="stat-item">
                <span class="stat-label">å€‹äººæœ€é«˜ç´€éŒ„ï¼š</span>
                <span class="stat-value" id="finalBestTime">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å­˜æ´»æ™‚é–“ï¼š</span>
                <span class="stat-value" id="finalSurvivalTime">0</span>
            </div>
        </div>
        
        <div class="game-actions">
            <button class="btn" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
            <button class="btn" onclick="handleBackClick(event)">è¿”å›</button>
        </div>
    </div>

    <script>
        class MouseWheelGame {
            constructor() {
                this.isPlaying = false;
                this.isPaused = false;
                this.survivalTime = 0;
                this.bestTime = 0;
                this.ballCount = 0;
                this.gameInterval = null;
                this.timeInterval = null;
                this.balls = [];
                this.stickmanX = window.innerWidth / 2;
                this.stickmanSpeed = 30; // æé«˜äººç‰©ç§»å‹•é€Ÿåº¦
                this.ballSpawnRate = 2000; // æ¯2ç§’ç”Ÿæˆä¸€å€‹çƒ
                this.lastBallSpawn = 0;
                this.gameSpeed = 1;
                this.initialBallCount = 9; // åˆå§‹çƒæ•¸
                this.debugMode = false; // èª¿è©¦æ¨¡å¼
                this.userId = null; // æ·»åŠ ç”¨æˆ¶ID
                this.pausedElapsedTime = 0; // æš«åœæ™‚ç´¯è¨ˆçš„å·²éæ™‚é–“
                
                // ç«æŸ´äººå‹•ç•«ç‹€æ…‹
                this.stickmanDirection = 'right'; // ç•¶å‰æœå‘
                this.stickmanMoving = false; // æ˜¯å¦æ­£åœ¨ç§»å‹•
                this.lastMoveTime = 0; // ä¸Šæ¬¡ç§»å‹•æ™‚é–“
                this.imagesPreloaded = false; // åœ–ç‰‡æ˜¯å¦å·²é è¼‰
                
                // è§’è½æ‡²ç½°ç³»çµ±
                this.cornerThreshold = 50; // è·é›¢é‚Šç•Œ50pxå…§ç®—è§’è½
                this.cornerTime = 0; // åœ¨è§’è½çš„æ™‚é–“
                this.maxCornerTime = 1.5; // æœ€å¤§å…è¨±åœ¨è§’è½1.5ç§’
                this.lastCornerCheck = 0; // ä¸Šæ¬¡æª¢æŸ¥è§’è½çš„æ™‚é–“
                
                this.initializeElements();
                this.setupEventListeners();
                this.loadUserInfo();
                // Shareç‰ˆæœ¬ï¼šç§»é™¤ClassIDåˆå§‹åŒ–
                this.preloadImages(); // é è¼‰åœ–ç‰‡
                this.loadBestTime(); // è¼‰å…¥æœ€é«˜ç§’æ•¸
                
                console.log('èº²é¿çƒéŠæˆ²åˆå§‹åŒ–å®Œæˆ');
            }
            
            async loadUserInfo() {
                try {
                    const response = await fetch('/api/current-user');
                    const userInfo = await response.json();
                    this.userId = userInfo.user_id;
                    console.log(`ç•¶å‰ç”¨æˆ¶ID: ${this.userId}`);
                    
                    // æ¸…ç†èˆŠçš„localStorageæ•¸æ“š
                    this.cleanupOldStorage();
                } catch (error) {
                    console.log('ç„¡æ³•ç²å–ç”¨æˆ¶ä¿¡æ¯ï¼Œä½¿ç”¨é»˜èªè¨­ç½®');
                    this.userId = 'anonymous';
                }
            }
            
            cleanupOldStorage() {
                // æ¸…ç†èˆŠçš„å…¨å±€localStorageéµå€¼
                const oldKey = 'dodgeball_best_time';
                if (localStorage.getItem(oldKey)) {
                    console.log('æ¸…ç†èˆŠçš„localStorageæ•¸æ“š');
                    localStorage.removeItem(oldKey);
                }
                
                // Shareç‰ˆæœ¬ï¼šç§»é™¤class_idæ¸…ç†
            }
            
            getStorageKey() {
                return `dodgeball_best_time_${this.userId}`;
            }
            
            // Shareç‰ˆæœ¬ï¼šç§»é™¤ClassIDç›¸é—œå‡½æ•¸

            initializeElements() {
                this.survivalTimeElement = document.getElementById('survivalTime');
                this.bestTimeElement = document.getElementById('bestTime');
                this.ballCountElement = document.getElementById('ballCount');
                this.gameArea = document.getElementById('gameArea');
                this.gameOver = document.getElementById('gameOver');
                this.stickman = document.getElementById('stickman');
                
                console.log('å…ƒç´ åˆå§‹åŒ–å®Œæˆ');
            }

            loadBestTime() {
                const savedBestTime = localStorage.getItem(this.getStorageKey());
                if (savedBestTime) {
                    this.bestTime = parseFloat(savedBestTime);
                    this.updateDisplay();
                }
                
                // Shareç‰ˆæœ¬ï¼šä¸å¾ä¼ºæœå™¨è¼‰å…¥æœ€ä½³è¨˜éŒ„
            }
            
            // Shareç‰ˆæœ¬ï¼šä¸å¾ä¼ºæœå™¨è¼‰å…¥æœ€ä½³è¨˜éŒ„

            saveBestTime() {
                if (this.survivalTime > this.bestTime) {
                    this.bestTime = this.survivalTime;
                    localStorage.setItem(this.getStorageKey(), this.bestTime.toString());
                    console.log(`æ–°ç´€éŒ„ï¼æœ€é«˜ç§’æ•¸ï¼š${this.bestTime.toFixed(2)}ç§’`);
                }
            }

            preloadImages() {
                const imagePaths = [
                    '../static/mouse-wheel/standing_left.png',
                    '../static/mouse-wheel/standing_right.png',
                    '../static/mouse-wheel/moving_left.png',
                    '../static/mouse-wheel/moving_left (2).png',
                    '../static/mouse-wheel/moving_left (3).png',
                    '../static/mouse-wheel/moving_left (4).png',
                    '../static/mouse-wheel/moving_left (5).png',
                    '../static/mouse-wheel/moving_right.png',
                    '../static/mouse-wheel/moving_right (2).png',
                    '../static/mouse-wheel/moving_right (3).png',
                    '../static/mouse-wheel/moving_right (4).png',
                    '../static/mouse-wheel/moving_right (5).png'
                ];
                
                let loadedCount = 0;
                const totalImages = imagePaths.length;
                
                imagePaths.forEach(path => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            this.imagesPreloaded = true;
                            console.log('æ‰€æœ‰ç«æŸ´äººåœ–ç‰‡å·²é è¼‰å®Œæˆ');
                        }
                    };
                    img.onerror = () => {
                        console.warn('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', path);
                        loadedCount++;
                        if (loadedCount === totalImages) {
                            this.imagesPreloaded = true;
                        }
                    };
                    img.src = path;
                });
            }

            setupEventListeners() {
                // æ»‘é¼ æ»¾è¼ªäº‹ä»¶
                document.addEventListener('wheel', (e) => this.handleWheel(e));
                
                // é˜²æ­¢é é¢æ»¾å‹•
                document.addEventListener('wheel', (e) => e.preventDefault(), { passive: false });
                
                // éµç›¤äº‹ä»¶è™•ç†
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.isPlaying) {
                        console.log('ESCéµæŒ‰ä¸‹ï¼Œå¼·åˆ¶çµæŸéŠæˆ²');
                        this.endGame();
                    } else if (e.key === ' ' && this.isPlaying) {
                        e.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
                        console.log('ç©ºç™½éµæŒ‰ä¸‹ï¼Œåˆ‡æ›æš«åœç‹€æ…‹');
                        this.togglePause();
                    } else if (e.key === 'd' || e.key === 'D') {
                        // æŒ‰Déµåˆ‡æ›èª¿è©¦æ¨¡å¼
                        this.toggleDebugMode();
                    }
                });
                
                console.log('äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
            }

            startGame() {
                if (this.isPlaying) return;
                
                console.log('é–‹å§‹éŠæˆ²...');
                this.isPlaying = true;
                this.survivalTime = 0;
                this.ballCount = 0;
                this.balls = [];
                this.stickmanX = window.innerWidth / 2;
                this.gameSpeed = 1;
                this.ballSpawnRate = 2000;
                this.lastBallSpawn = 0;
                this.initialBallCount = 9; // åˆå§‹çƒæ•¸
                this.pausedElapsedTime = 0; // é‡ç½®æš«åœç´¯è¨ˆæ™‚é–“
                
                // åˆå§‹åŒ–è§’è½æ‡²ç½°ç³»çµ±
                this.cornerTime = 0;
                this.lastCornerCheck = Date.now();
                
                this.updateDisplay();
                this.updateStickmanPosition();
                
                const instructionsElement = document.getElementById('gameInstructions');
                if (instructionsElement) {
                    instructionsElement.style.display = 'none';
                }
                
                this.startTimer();
                this.startGameLoop();
                
                // éŠæˆ²é–‹å§‹æ™‚ç”Ÿæˆåˆå§‹çƒ
                this.spawnInitialBalls();
                
                console.log('éŠæˆ²å·²é–‹å§‹');
            }

            startTimer() {
                this.startTimestamp = Date.now();
                this._speedBoostAppliedAt = new Set();
                this.timeInterval = setInterval(() => {
                    const elapsedMs = Date.now() - this.startTimestamp;
                    this.survivalTime = elapsedMs / 1000;
                    this.updateDisplay();
                    
                    const wholeSeconds = Math.floor(this.survivalTime);
                    if (wholeSeconds > 0 && wholeSeconds % 30 === 0 && !this._speedBoostAppliedAt.has(wholeSeconds)) {
                        this._speedBoostAppliedAt.add(wholeSeconds);
                        this.gameSpeed += 0.2;
                        this.ballSpawnRate = Math.max(500, this.ballSpawnRate - 200);
                        console.log(`éŠæˆ²é€Ÿåº¦æå‡ï¼ç•¶å‰é€Ÿåº¦: ${this.gameSpeed.toFixed(1)}x`);
                    }
                }, 50);
            }

            startGameLoop() {
                this.gameInterval = setInterval(() => {
                    if (!this.isPlaying || this.isPaused) return;
                    
                    this.updateBalls();
                    this.checkCollisions();
                    this.spawnBalls();
                    this.updateStickmanAnimation(); // æ›´æ–°ç«æŸ´äººå‹•ç•«
                    this.checkCornerPenalty(); // æª¢æŸ¥è§’è½æ‡²ç½°
                }, 16); // ç´„60FPS
            }

            handleWheel(e) {
                if (!this.isPlaying || this.isPaused) return;
                
                e.preventDefault();
                
                // è¨˜éŒ„ç§»å‹•æ™‚é–“å’Œæ–¹å‘
                this.lastMoveTime = Date.now();
                this.stickmanMoving = true;
                
                // æ»¾è¼ªå‘ä¸‹ = å¾€å³èµ°
                if (e.deltaY > 0) {
                    this.stickmanX += this.stickmanSpeed;
                    this.stickmanDirection = 'right';
                }
                // æ»¾è¼ªå‘ä¸Š = å¾€å·¦èµ°
                else if (e.deltaY < 0) {
                    this.stickmanX -= this.stickmanSpeed;
                    this.stickmanDirection = 'left';
                }
                
                // é™åˆ¶ç«æŸ´äººåœ¨éŠæˆ²å€åŸŸå…§
                const stickmanWidth = 60; // æ›´æ–°ç‚ºæ–°çš„å¯¬åº¦
                this.stickmanX = Math.max(stickmanWidth / 2, Math.min(window.innerWidth - stickmanWidth / 2, this.stickmanX));
                
                this.updateStickmanPosition();
                this.updateStickmanAnimation();
            }

            updateStickmanPosition() {
                this.stickman.style.left = this.stickmanX + 'px';
            }

            updateStickmanAnimation() {
                // å¦‚æœéŠæˆ²çµæŸæˆ–åœ–ç‰‡é‚„æ²’é è¼‰å®Œæˆï¼Œä¸é€²è¡Œå‹•ç•«åˆ‡æ›
                if (!this.isPlaying || !this.imagesPreloaded) {
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦æ‡‰è©²åœæ­¢ç§»å‹•å‹•ç•«
                const now = Date.now();
                if (now - this.lastMoveTime > 300) { // å»¶é•·åˆ°300mså¾Œåœæ­¢ç§»å‹•å‹•ç•«
                    this.stickmanMoving = false;
                }
                
                // æ ¹æ“šç‹€æ…‹è¨­ç½®å°æ‡‰çš„å‹•ç•«é¡åˆ¥
                if (this.stickmanMoving) {
                    // ç§»å‹•æ™‚ï¼šå…ˆæ¸…é™¤æ‰€æœ‰é¡åˆ¥ï¼Œå†æ·»åŠ å°æ‡‰çš„ç§»å‹•å‹•ç•«
                    this.stickman.className = 'stickman';
                    if (this.stickmanDirection === 'left') {
                        this.stickman.classList.add('moving-left');
                    } else {
                        this.stickman.classList.add('moving-right');
                    }
                } else {
                    // ç«™ç«‹æ™‚ï¼šå…ˆæ¸…é™¤æ‰€æœ‰é¡åˆ¥ï¼Œå†æ·»åŠ å°æ‡‰çš„ç«™ç«‹å‹•ç•«
                    this.stickman.className = 'stickman';
                    if (this.stickmanDirection === 'left') {
                        this.stickman.classList.add('standing-left');
                    } else {
                        this.stickman.classList.add('standing-right');
                    }
                }
            }

            checkCornerPenalty() {
                const now = Date.now();
                const deltaTime = (now - this.lastCornerCheck) / 1000; // è½‰æ›ç‚ºç§’
                this.lastCornerCheck = now;
                
                // æª¢æŸ¥æ˜¯å¦åœ¨è§’è½
                const isInLeftCorner = this.stickmanX <= this.cornerThreshold;
                const isInRightCorner = this.stickmanX >= window.innerWidth - this.cornerThreshold;
                const isInCorner = isInLeftCorner || isInRightCorner;
                
                if (isInCorner) {
                    // åœ¨è§’è½ï¼Œç´¯è¨ˆæ™‚é–“
                    this.cornerTime += deltaTime;
                    
                    // èª¿è©¦ä¿¡æ¯
                    if (this.cornerTime > 0.5 && this.cornerTime < 0.6) {
                        console.log(`è§’è½æª¢æ¸¬ï¼šä½ç½®=${this.stickmanX.toFixed(1)}, è§’è½æ™‚é–“=${this.cornerTime.toFixed(2)}ç§’`);
                    }
                    
                    // å¦‚æœè¶…éæœ€å¤§å…è¨±æ™‚é–“ï¼ŒåŸ·è¡Œæ‡²ç½°
                    if (this.cornerTime >= this.maxCornerTime) {
                        this.applyCornerPenalty();
                    }
                } else {
                    // ä¸åœ¨è§’è½ï¼Œé‡ç½®æ™‚é–“
                    if (this.cornerTime > 0) {
                        console.log(`é›¢é–‹è§’è½ï¼Œé‡ç½®æ™‚é–“ã€‚ä¹‹å‰è§’è½æ™‚é–“ï¼š${this.cornerTime.toFixed(2)}ç§’`);
                    }
                    this.cornerTime = 0;
                }
            }

            applyCornerPenalty() {
                // å°‡ç«æŸ´äººæ¨å‘ä¸­é–“
                const centerX = window.innerWidth / 2;
                const pushDistance = 150; // æ¯æ¬¡æ¨å‹•150px
                
                if (this.stickmanX < centerX) {
                    // åœ¨å·¦é‚Šï¼Œå‘å³æ¨
                    this.stickmanX = Math.min(this.stickmanX + pushDistance, centerX);
                } else {
                    // åœ¨å³é‚Šï¼Œå‘å·¦æ¨
                    this.stickmanX = Math.max(this.stickmanX - pushDistance, centerX);
                }
                
                // æ›´æ–°ä½ç½®
                this.updateStickmanPosition();
                
                // é‡ç½®è§’è½æ™‚é–“
                this.cornerTime = 0;
                
                console.log(`è§’è½æ‡²ç½°ï¼šç«æŸ´äººè¢«æ¨å‘ä¸­é–“ï¼Œæ–°ä½ç½®: ${this.stickmanX.toFixed(1)}`);
            }

            spawnBalls() {
                // ä¸å†å¢åŠ çƒï¼šç•¶å‰çƒæ•¸é”åˆ°åˆå§‹å€¼å‰‡ä¸å†ç”Ÿæˆ
                if (this.balls.length >= this.initialBallCount) return;
                const now = Date.now();
                if (now - this.lastBallSpawn > this.ballSpawnRate) {
                    this.createBall();
                    this.lastBallSpawn = now;
                }
            }

            spawnInitialBalls() {
                // ç”Ÿæˆä¹ç¨®ä¸åŒé¡å‹çš„çƒ
                const types = ['type1', 'type2', 'type3', 'type4', 'type5', 'type6', 'type7', 'type8', 'type9'];
                const sizeMap = {
                    'type1': 120, 'type2': 140, 'type3': 160, 'type4': 180, 'type5': 200,
                    'type6': 220, 'type7': 240, 'type8': 260, 'type9': 280
                };
                
                for (let i = 0; i < this.initialBallCount; i++) {
                    const type = types[i % types.length]; // å¾ªç’°ä½¿ç”¨ä¹ç¨®é¡å‹
                    const size = sizeMap[type];
                    this.createBall(type, -(i * 30 + size));
                }
                console.log(`åˆå§‹${this.initialBallCount}é¡†çƒï¼ˆä¹ç¨®ä¸åŒè¨­è¨ˆï¼‰å·²ç”Ÿæˆ`);
            }

            createBall(forcedType = null, forcedY = null) {
                const ball = document.createElement('div');
                ball.className = 'ball';
                
                // éš¨æ©Ÿé¸æ“‡çƒçš„é¡å‹ï¼ˆ1-9ï¼‰
                const types = ['type1', 'type2', 'type3', 'type4', 'type5', 'type6', 'type7', 'type8', 'type9'];
                const type = forcedType || types[Math.floor(Math.random() * types.length)];
                ball.classList.add(type);
                
                // æ ¹æ“šé¡å‹è¨­å®šå°ºå¯¸
                const sizeMap = {
                    'type1': 120, 'type2': 140, 'type3': 160, 'type4': 180, 'type5': 200,
                    'type6': 220, 'type7': 240, 'type8': 260, 'type9': 280
                };
                const tempWidth = sizeMap[type];
                
                // éš¨æ©Ÿä½ç½®å’Œé€Ÿåº¦
                const x = Math.random() * Math.max(1, (window.innerWidth - tempWidth));
                const y = forcedY !== null ? forcedY : -tempWidth * 1.8;
                
                // æ‰€æœ‰çƒçš„é€Ÿåº¦éƒ½åœ¨5~10ä¹‹é–“éš¨æ©ŸåŒ–
                const speed = 5 + Math.random() * 5;
                const angle = (Math.random() - 0.5) * Math.PI * 0.8;
                const vx = Math.cos(angle) * speed * this.gameSpeed;
                const vy = Math.sin(angle) * speed * this.gameSpeed;
                
                ball.style.left = x + 'px';
                ball.style.top = y + 'px';
                
                this.gameArea.appendChild(ball);
                
                const ballData = {
                    element: ball,
                    x: x,
                    y: y,
                    vx: vx,
                    vy: vy,
                    type: type,
                    width: tempWidth,
                    height: tempWidth
                };
                
                this.balls.push(ballData);
                this.ballCount++;
                this.updateDisplay();
                
                console.log(`çƒå·²ç”Ÿæˆ: ${type}, ä½ç½®: (${x}, ${y})`);
            }

            updateBalls() {
                for (let i = this.balls.length - 1; i >= 0; i--) {
                    const ball = this.balls[i];
                    
                    // æ›´æ–°ä½ç½®
                    ball.x += ball.vx;
                    ball.y += ball.vy;
                    
                    // é—œé–‰é‡åŠ›ï¼šä¿æŒå›ºå®šå‚ç›´é€Ÿåº¦ï¼ˆä¸ç¬¦åˆè‡ªç”±è½é«”ï¼‰
                    // ä¸å†ç´¯åŠ é‡åŠ›ï¼ŒåŠ é€Ÿç”±åˆå§‹ vy æ±ºå®š
                    
                    // é‚Šç•Œç¢°æ’æª¢æ¸¬ï¼ˆå·¦å³ã€ä¸Šï¼‰
                    if (ball.x <= 0 || ball.x >= window.innerWidth - ball.width) {
                        ball.vx *= -0.8; // åå½ˆï¼Œä½†æå¤±ä¸€äº›èƒ½é‡
                        ball.x = Math.max(0, Math.min(window.innerWidth - ball.width, ball.x));
                    }
                    if (ball.y <= 0) {
                        ball.y = 0;
                        ball.vy = Math.abs(ball.vy); // ä¸Šé‚Šç•Œåå½ˆå‘ä¸‹
                    }
                    
                    // åœ°é¢ç¢°æ’æª¢æ¸¬
                    if (ball.y >= window.innerHeight - ball.height - 100) { // 100æ˜¯åœ°é¢é«˜åº¦
                        ball.y = window.innerHeight - ball.height - 100;
                        // å®Œå…¨å½ˆæ€§åå½ˆï¼šä¸æ¸›é€Ÿï¼Œåƒ…ç¿»è½‰æ–¹å‘
                        ball.vy = -Math.abs(ball.vy);
                        // ä¸æ–½åŠ åœ°é¢æ‘©æ“¦ï¼Œä¿æŒæ°´å¹³é€Ÿåº¦ä¸è®Š
                    }
                    
                    // çƒèˆ‡çƒä¹‹é–“çš„ç¢°æ’æª¢æ¸¬ï¼ˆå®Œå…¨å½ˆæ€§ + é‡ç–Šåˆ†é›¢ï¼‰
                    for (let j = i + 1; j < this.balls.length; j++) {
                        const otherBall = this.balls[j];
                        const dx = (ball.x + ball.width/2) - (otherBall.x + otherBall.width/2);
                        const dy = (ball.y + ball.height/2) - (otherBall.y + otherBall.height/2);
                        const distance = Math.sqrt(dx * dx + dy * dy) || 0.0001;
                        const minDistance = (ball.width + otherBall.width) / 2;

                        if (distance < minDistance) {
                            const nx = dx / distance;
                            const ny = dy / distance;

                            const rvx = ball.vx - otherBall.vx;
                            const rvy = ball.vy - otherBall.vy;
                            const velAlongNormal = rvx * nx + rvy * ny;

                            // åˆ†é›¢é‡ç–Š
                            const overlap = (minDistance - distance);
                            const separation = overlap / 2;
                            ball.x += nx * separation;
                            ball.y += ny * separation;
                            otherBall.x -= nx * separation;
                            otherBall.y -= ny * separation;

                            if (velAlongNormal < 0) {
                                // å®Œå…¨å½ˆæ€§ç¢°æ’ï¼ˆä¸æ¸›é€Ÿï¼‰
                                const restitution = 1.0;
                                const impulse = -(1 + restitution) * velAlongNormal / 2; // ç­‰è³ªé‡

                                const impulseX = impulse * nx;
                                const impulseY = impulse * ny;

                                ball.vx += impulseX;
                                ball.vy += impulseY;
                                otherBall.vx -= impulseX;
                                otherBall.vy -= impulseY;
                                
                                // ç¢ºä¿ç¢°æ’å¾Œä¿æŒæœ€å°é€Ÿåº¦
                                const minSpeed = 5.0;
                                const maxSpeed = 10.0;
                                const speed1 = Math.hypot(ball.vx, ball.vy);
                                const speed2 = Math.hypot(otherBall.vx, otherBall.vy);
                                
                                if (speed1 < minSpeed) {
                                    const dir1 = Math.atan2(ball.vy, ball.vx);
                                    ball.vx = Math.cos(dir1) * minSpeed;
                                    ball.vy = Math.sin(dir1) * minSpeed;
                                } else if (speed1 > maxSpeed) {
                                    const dir1 = Math.atan2(ball.vy, ball.vx);
                                    ball.vx = Math.cos(dir1) * maxSpeed;
                                    ball.vy = Math.sin(dir1) * maxSpeed;
                                }
                                
                                if (speed2 < minSpeed) {
                                    const dir2 = Math.atan2(otherBall.vy, otherBall.vx);
                                    otherBall.vx = Math.cos(dir2) * minSpeed;
                                    otherBall.vy = Math.sin(dir2) * minSpeed;
                                } else if (speed2 > maxSpeed) {
                                    const dir2 = Math.atan2(otherBall.vy, otherBall.vx);
                                    otherBall.vx = Math.cos(dir2) * maxSpeed;
                                    otherBall.vy = Math.sin(dir2) * maxSpeed;
                                }
                            }
                        }
                    }

                    // é¿å…æ°´å¹³é£›è¡Œï¼šè‹¥è§’åº¦åœ¨ Â±20Â° å…§ï¼Œèª¿æ•´ç‚ºæœ€å°ä»°è§’ä½†ä¿æŒé€Ÿåº¦èˆ‡æ–¹å‘
                    const speed = Math.hypot(ball.vx, ball.vy);
                    if (speed > 0) {
                        const minAngle = Math.PI * 20 / 180; // 20 åº¦
                        const angle = Math.atan2(ball.vy, ball.vx);
                        if (Math.abs(angle) < minAngle) {
                            const dirX = ball.vx >= 0 ? 1 : -1;
                            const dirY = ball.vy === 0 ? (Math.random() < 0.5 ? -1 : 1) : (ball.vy >= 0 ? 1 : -1);
                            ball.vx = dirX * Math.cos(minAngle) * speed;
                            ball.vy = dirY * Math.sin(minAngle) * speed;
                        }
                    }
                    
                    // é¡å¤–æª¢æŸ¥ï¼šé¿å…ç´”æ°´å¹³é‹å‹•ï¼ˆvyæ¥è¿‘0ï¼‰
                    if (Math.abs(ball.vy) < 0.5) {
                        const speed = Math.hypot(ball.vx, ball.vy);
                        if (speed > 0) {
                            const minVerticalSpeed = 2.0; // æœ€å°å‚ç›´é€Ÿåº¦
                            const dirY = Math.random() < 0.5 ? -1 : 1; // éš¨æ©Ÿä¸Šä¸‹æ–¹å‘
                            ball.vy = dirY * minVerticalSpeed;
                            ball.vx = ball.vx * 0.8; // ç¨å¾®æ¸›æ…¢æ°´å¹³é€Ÿåº¦
                        }
                    }
                    
                    // æ›´æ–°DOMä½ç½®
                    ball.element.style.left = ball.x + 'px';
                    ball.element.style.top = ball.y + 'px';
                    
                    // ä¿ç•™åœ¨å ´ä¸Šï¼šä¸å†ç§»é™¤è¶…å‡ºè¢å¹•çš„çƒï¼ˆå·²ç”±é‚Šç•Œåå½ˆè™•ç†ï¼‰
                }
            }

            removeBall(index) {
                const ball = this.balls[index];
                if (ball.element.parentNode) {
                    ball.element.parentNode.removeChild(ball.element);
                }
                this.balls.splice(index, 1);
            }

            checkCollisions() {
                // èª¿æ•´ç«æŸ´äººçš„ç¢°æ’å€åŸŸï¼šå·¦å³å„5pxï¼Œç¸½é«˜åº¦60px
                const stickmanRect = {
                    left: this.stickmanX - 5,     // å·¦å³å„5px
                    right: this.stickmanX + 5,   // å·¦å³å„5px
                    top: window.innerHeight - 160, // ç¸½é«˜åº¦60pxï¼Œå¾åº•éƒ¨100pxé–‹å§‹
                    bottom: window.innerHeight - 100 // ç«æŸ´äººåº•éƒ¨ä½ç½®
                };
                
                for (let i = this.balls.length - 1; i >= 0; i--) {
                    const ball = this.balls[i];
                    
                    // åœ“å½¢ç¢°æ’æª¢æ¸¬
                    const ballCenterX = ball.x + ball.width / 2;
                    const ballCenterY = ball.y + ball.height / 2;
                    const ballRadius = ball.width / 2;
                    
                    // æª¢æŸ¥çƒæ˜¯å¦èˆ‡ç«æŸ´äººçŸ©å½¢ç¢°æ’
                    const closestX = Math.max(stickmanRect.left, Math.min(ballCenterX, stickmanRect.right));
                    const closestY = Math.max(stickmanRect.top, Math.min(ballCenterY, stickmanRect.bottom));
                    
                    const distanceX = ballCenterX - closestX;
                    const distanceY = ballCenterY - closestY;
                    const distanceSquared = distanceX * distanceX + distanceY * distanceY;
                    
                    // å¦‚æœè·é›¢å°æ–¼çƒçš„åŠå¾‘ï¼Œå‰‡ç™¼ç”Ÿç¢°æ’
                    if (distanceSquared < ballRadius * ballRadius) {
                        console.log(`ç«æŸ´äººè¢«çƒæ“Šä¸­ï¼çƒåŠå¾‘: ${ballRadius.toFixed(1)}, è·é›¢: ${Math.sqrt(distanceSquared).toFixed(1)}`);
                        this.endGame();
                        return;
                    }
                }
            }

            updateDisplay() {
                this.survivalTimeElement.textContent = this.survivalTime.toFixed(2);
                this.bestTimeElement.textContent = this.bestTime.toFixed(2);
                this.ballCountElement.textContent = this.ballCount;
                
                // æœ€å¾Œ30ç§’æ™‚é–“é¡¯ç¤ºè­¦å‘Šæ•ˆæœ
                if (this.survivalTime >= 30 && this.survivalTime % 30 >= 25) {
                    this.survivalTimeElement.classList.add('warning');
                } else {
                    this.survivalTimeElement.classList.remove('warning');
                }
            }

            endGame() {
                this.isPlaying = false;
                
                clearInterval(this.timeInterval);
                clearInterval(this.gameInterval);
                
                // åœæ­¢ç«æŸ´äººå‹•ç•«ï¼Œä¿æŒæœ€å¾Œçš„ç‹€æ…‹
                this.stickmanMoving = false;
                this.stickman.className = 'stickman';
                if (this.stickmanDirection === 'left') {
                    this.stickman.classList.add('standing-left');
                } else {
                    this.stickman.classList.add('standing-right');
                }
                
                // åœæ­¢æ‰€æœ‰çƒçš„ç§»å‹•ï¼Œè®“å®ƒå€‘å®šæ ¼åœ¨ç•¶å‰ä½ç½®
                this.balls.forEach(ball => {
                    ball.element.style.animationPlayState = 'paused';
                    ball.element.style.transition = 'none';
                });
                
                // æ›´æ–°æœ€çµ‚çµ±è¨ˆ
                document.getElementById('finalScore').textContent = this.survivalTime.toFixed(2) + 'ç§’';
                document.getElementById('finalSurvivalTime').textContent = this.survivalTime.toFixed(2) + 'ç§’';
                document.getElementById('finalBestTime').textContent = this.bestTime.toFixed(2) + 'ç§’';
                
                // ä¿å­˜æœ€é«˜ç§’æ•¸
                this.saveBestTime();
                
                // Shareç‰ˆæœ¬ï¼šåˆ†æ•¸è¨ˆç®—å®Œæˆï¼Œä¸æäº¤åˆ°æ’è¡Œæ¦œ
                
                this.gameOver.style.display = 'block';
                
                console.log(`éŠæˆ²çµæŸï¼å­˜æ´»æ™‚é–“ï¼š${this.survivalTime.toFixed(2)}ç§’`);
            }

            // Shareç‰ˆæœ¬ï¼šä¸æäº¤åˆ†æ•¸åˆ°æ’è¡Œæ¦œï¼Œåªè¨ˆç®—å’Œé¡¯ç¤ºåˆ†æ•¸

            restartGame() {
                // æ¸…é™¤æ‰€æœ‰çƒ
                this.balls.forEach(ball => {
                    if (ball.element.parentNode) {
                        ball.element.parentNode.removeChild(ball.element);
                    }
                });
                this.balls = [];
                
                this.gameOver.style.display = 'none';
                this.startGame();
            }

            pauseGame() {
                if (!this.isPlaying || this.isPaused) return;
                
                this.isPaused = true;
                clearInterval(this.timeInterval);
                clearInterval(this.gameInterval);
                
                // è¨˜éŒ„æš«åœæ™‚å·²éå»çš„æ™‚é–“ï¼Œä»¥ä¾¿æ¢å¾©æ™‚ç¹¼çºŒè¨ˆæ™‚
                if (this.startTimestamp) {
                    const elapsedMs = Date.now() - this.startTimestamp;
                    this.pausedElapsedTime = (this.pausedElapsedTime || 0) + elapsedMs;
                }
                
                // æ›´æ–°æš«åœæŒ‰éˆ•åœ–æ¨™
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'â–¶ï¸';
                }
                
                console.log('éŠæˆ²å·²æš«åœ');
            }

            resumeGame() {
                if (!this.isPlaying || !this.isPaused) return;
                
                this.isPaused = false;
                
                // èª¿æ•´é–‹å§‹æ™‚é–“æˆ³ï¼Œä½¿è¨ˆæ™‚å™¨å¾æš«åœå‰çš„æ™‚é–“ç¹¼çºŒ
                if (this.pausedElapsedTime) {
                    this.startTimestamp = Date.now() - this.pausedElapsedTime;
                } else {
                    this.startTimestamp = Date.now();
                }
                
                // é‡æ–°å•Ÿå‹•è¨ˆæ™‚å™¨å’ŒéŠæˆ²å¾ªç’°
                this._speedBoostAppliedAt = new Set();
                this.timeInterval = setInterval(() => {
                    const elapsedMs = Date.now() - this.startTimestamp;
                    this.survivalTime = elapsedMs / 1000;
                    this.updateDisplay();
                    
                    const wholeSeconds = Math.floor(this.survivalTime);
                    if (wholeSeconds > 0 && wholeSeconds % 30 === 0 && !this._speedBoostAppliedAt.has(wholeSeconds)) {
                        this._speedBoostAppliedAt.add(wholeSeconds);
                        this.gameSpeed += 0.2;
                        this.ballSpawnRate = Math.max(500, this.ballSpawnRate - 200);
                        console.log(`éŠæˆ²é€Ÿåº¦æå‡ï¼ç•¶å‰é€Ÿåº¦: ${this.gameSpeed.toFixed(1)}x`);
                    }
                }, 50);
                
                this.startGameLoop();
                
                // æ›´æ–°æš«åœæŒ‰éˆ•åœ–æ¨™
                const pauseBtn = document.getElementById('pauseBtn');
                if (pauseBtn) {
                    pauseBtn.textContent = 'â¸ï¸';
                }
                
                console.log('éŠæˆ²å·²æ¢å¾©');
            }

            togglePause() {
                if (this.isPaused) {
                    this.resumeGame();
                } else {
                    this.pauseGame();
                }
            }

            toggleDebugMode() {
                this.debugMode = !this.debugMode;
                if (this.debugMode) {
                    document.body.classList.add('debug-mode');
                    console.log('èª¿è©¦æ¨¡å¼å·²é–‹å•Ÿ - æŒ‰Déµå¯é—œé–‰');
                } else {
                    document.body.classList.remove('debug-mode');
                    console.log('èª¿è©¦æ¨¡å¼å·²é—œé–‰ - æŒ‰Déµå¯é–‹å•Ÿ');
                }
            }
        }

        // å…¨åŸŸè®Šæ•¸
        let game;

        function startGameWithInstructions() {
            const instructionsElement = document.getElementById('gameInstructions');
            if (instructionsElement) {
                instructionsElement.style.display = 'none';
            }
            
            if (game) {
                game.startGame();
            }
        }


        function restartGame() {
            if (game) {
                game.restartGame();
            }
        }

        // Shareç‰ˆæœ¬ï¼šç§»é™¤viewLeaderboardå‡½æ•¸

        function handleBackClick(event) {
            if (event) {
                event.preventDefault();
            }
            // Shareç‰ˆæœ¬ï¼šè¿”å›ä¸»ä»‹é¢
            const currentPath = window.location.pathname;
            if (currentPath.includes('/share/')) {
                window.location.href = '/share';
            } else {
                // å¦‚æœä¸æ˜¯Shareç‰ˆæœ¬ï¼Œä½¿ç”¨ç€è¦½å™¨å¾Œé€€
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.location.href = '/';
                }
            }
        }

        function togglePause() {
            if (game) {
                game.togglePause();
            }
        }

        // åˆå§‹åŒ–éŠæˆ²
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMè¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–æ»‘é¼ æ»¾è¼ªéŠæˆ²...');
            game = new MouseWheelGame();
            console.log('æ»‘é¼ æ»¾è¼ªéŠæˆ²å¯¦ä¾‹å‰µå»ºå®Œæˆ:', game);
            
            // ç¢ºä¿éŠæˆ²èªªæ˜å½ˆçª—åœ¨éŠæˆ²è¼‰å…¥æ™‚é¡¯ç¤º
            const instructionsElement = document.getElementById('gameInstructions');
            if (instructionsElement) {
                instructionsElement.style.display = 'flex';
                console.log('éŠæˆ²èªªæ˜å½ˆçª—å·²é¡¯ç¤º');
            } else {
                console.error('æ‰¾ä¸åˆ°éŠæˆ²èªªæ˜å½ˆçª—å…ƒç´ ');
            }
            
            // æ·»åŠ é é¢å¯è¦‹æ€§æª¢æ¸¬
            document.addEventListener('visibilitychange', () => {
                if (game && game.isPlaying) {
                    if (document.hidden) {
                        // é é¢ä¸å¯è¦‹æ™‚æš«åœéŠæˆ²
                        console.log('é é¢ä¸å¯è¦‹ï¼Œè‡ªå‹•æš«åœéŠæˆ²');
                        game.pauseGame();
                    } else {
                        // é é¢å¯è¦‹æ™‚æ¢å¾©éŠæˆ²
                        console.log('é é¢å¯è¦‹ï¼Œè‡ªå‹•æ¢å¾©éŠæˆ²');
                        game.resumeGame();
                    }
                }
            });
            
            console.log('æ»‘é¼ æ»¾è¼ªéŠæˆ²åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
